<!--
  - @copyright 2023 Passwords App
  -
  - @author Marius David Wieschollek
  - @license AGPL-3.0
  -
  - This file is part of the Passwords App
  - created by Marius David Wieschollek.
  -->

<script>
    import API from '@js/Helper/api';
    import BaseSection from '@vue/Section/BaseSection';
    import SettingsService from '@js/Services/SettingsService';
    import Application from "@js/Init/Application";
    import UtilityService from "@js/Services/UtilityService";
    import LocalisationService from "@js/Services/LocalisationService";

    export default {
        extends: BaseSection,

        data() {
            let showTags = SettingsService.get('client.ui.list.tags.show', false) && window.innerWidth > 360,
                model    = showTags ? 'model+passwords+password-tags':'model+passwords';

            return {
                currentTag  : null,
                model       : model
            };
        },

        computed: {
            getBreadcrumb() {
                let showAddNew = true,
                    items = [],
                    tagId;
                if(this.currentTag !== null) {
                    showAddNew = !this.currentTag.trashed;
                    tagId = this.currentTag.id;
                    let route = this.currentTag.trashed ? 'Trash':'Tags';

                    items = [
                        {path: {name:route}, label: LocalisationService.translate(route)},
                        {path: this.$route.path, label: this.currentTag.label}
                    ];
                }

                return {
                    newTag     : this.currentTag === null,
                    newPassword: this.currentTag !== null,
                    tag        : tagId,
                    showAddNew,
                    items
                };
            }
        },

        methods: {
            refreshView: function() {
                if(this.$route.params.tag !== undefined) {
                    this.tags = [];
                    if(!this.passwords.length) this.loading = true;
                    API.showTag(this.$route.params.tag, this.model).then(this.updatePasswordList);
                } else {
                    this.passwords = [];
                    this.currentTag = null;
                    if(!this.tags.length) this.loading = true;
                    API.listTags().then(this.updateTagList);
                }
            },

            updatePasswordList: function(tag) {
                this.loading = false;
                this.currentTag = tag;
                this.passwords = UtilityService.sortApiObjectArray(tag.passwords, this.getPasswordsSortingField(), this.sorting.ascending);
            }
        },
        watch  : {
            $route: function() {
                this.refreshView();
                Application.sidebar = null;
            }
        }
    };
</script>